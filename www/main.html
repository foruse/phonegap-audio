<!DOCTYPE html>
<html>
  <head>
    <script src="http://debug.build.phonegap.com/target/target-script-min.js#6f8f4166-1947-11e3-904e-12313d16b935"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://212.8.40.254:5959/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/helpers.js"></script>
    <script type="text/javascript" src="js/api.js"></script>
    
    <style>
        #container{
            width: 100%;
        }
        #chat{
            min-height: 200px;
        }
    </style>
  </head>
  <body>
    <div id="container">
        <div id="project">
            <div id="project-info"></div>
            <div id="project-partners"></div>
        </div>
        <div id="chat">
            
        </div>

       <div id="message">
            <div id="send-message">
                <input type="text" id="message-text" />
                <button id="send">send message</button>
                <button id="send-record">send record</button>
            </div>
            <div id="adds">
                <div> adds<br />
                    <button id="start_record">Record</button>
                    <button id="stop_record">Stop</button>
                    <button id="play_record">Play_record</button>
                    <div id="RecStatusID">Status: </div>
                    <div id="media_rec_pos">Audio position: 0 sec</div>
                </div><br />
                <div class="subheader" id="PhonegapVerID">Playback Using PhoneGap</div><br />
                <div>
                    <!--<button id="play">Play</button>-->
                    <button id="pause">Pause</button>
                    <button id="stop">Stop</button>

                    <div id="PlayStatusID">Status: </div>
                    <div id="media_pos">Audio position: 0 sec</div>
                </div>           
            </div>           
       </div>     

    </div>
   
      
    <script>
//          document.addEventListener("deviceready", onDeviceReady, false);

    // device APIs are available
    //
    function init_app() { //wrapper
        console.log("init_main_html FIRED!!!");
            
        var id = "xiao_projects_8w4bk484&20130916170458";
        Models.Project.read(id, function(data){
            // asynchronous method which have several events (project info and chat messages)

            console.log(data);
            if(data.partners){
                data.partners.forEach(function(el, i){
                    i === 0 ? $("#project-info").append('<div>'+el.name+" "+ el.description +'</div>') : "";
                    $("#project-partners").append(el.name);
                });
            }
            if(data.chat){
                data.chat.forEach(function(el, i){
                    $("#chat").append('<p>'+el.content+' <b>DB message</b> </p>');
                });
                Models.ProjectChat.update_chat(
                    id, // project_id
                    /* get message event*/
                    function(message){
                       console.log(message); 
                       $("#chat").append('<p>'+message.content+'  <b>  NOT MY</b>  </p>');
                       console.log("message--message--message--message--message--message--message--message--message--message--message--message--message--message--"); 
                    }
                );
            }
        });
//        });
        
        $(document).on("click", "#send", function(){
            var mess = $("#message-text").val();

            var data = {
//                content     :   "hello world",
                content     :   mess,
                type        :   "text",
                project_id  :   "xiao_projects_8w4bk484&20130916170458"
//                            user_id     :   "dsadasdas1212312"
//                user_id     :   SESSION.get("user_id")
            };

            Models.ProjectChat.send_message(data, function(message){
                $("#message-text").val("");
                $("#chat").append('<p>'+message.content+' <b> MY Message</b> </p>');
                console.log(message);
            });
        });
        
        var message = {};
        
        $(document).on("click", "#start_record", function(){
            console.log("start_record pushed");
            Models.VoiceMessage.record_start(function(file_path){
                console.log(file_path);
                message = {
                    content     : "",
                    type        : "audio",
                    project_id  : "xiao_projects_8w4bk484&20130916170458",
                    local_path  : file_path
                };
            });
        });
        
        $(document).on("click", "#play_record", function(){
            console.log("play_record pushed");
            Models.VoiceMessage.record_play();
        });

        $(document).on("click", "#stop_record", function(){
            console.log("stop_record pushed");
            Models.VoiceMessage.record_stop();
        });
        
        $(document).on("click", "#send-record", function(){
            console.log("send_record pushed");
            console.log(message);
            Models.ProjectChat.send_message(message, function(data){
                $("#message-text").val("");
                $("#chat").append('<p> VOice message <b> MY Message</b><button class="play-send-voice" vo-id="'+data.id+'">PLAY</button> </p>');
                console.log(data);
                message = {};
            });
        });
        
        $(document).on("click", ".play-send-voice", function(){
            console.log("play pushed");
            var id  = $(this).attr("vo-id");
            console.log(id);
            Models.VoiceMessage.play(id);
        });

//        $(document).on("click", "#play", function(){
//            console.log("play pushed");
//            Models.VoiceMessage.play();
//        });

        $(document).on("click", "#pause", function(){
            console.log("pause pushed");
            Models.VoiceMessage.pause();
        });

        $(document).on("click", "#stop", function(){
            console.log("stop pushed");
            Models.VoiceMessage.stop();
        });
        //////////////////


//        function init(){
//            Voice_message.INIT();
//            console.log("inited");
//        //    alert("Window")
//        //    alert(Window)
//        //    alert(window)
//        }
        
    }
    </script>
      
      
  </body>
</html>
